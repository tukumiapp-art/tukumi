import{j as e}from"./ui-BndUj6rU.js";import{r as i,u as ve}from"./vendor-C_rG9DFw.js";import{d as N,a as De,s as le}from"./index-gjDmyrly.js";import{o as Fe,q as me,n as ue,k as D,h as K,j as $,D as we,B as te,v as F,w as ze,E as ne,F as oe,G as ce,t as G,u as _,H as de,I as Ue,J as se,K as ye}from"./firebase-BaLQ-sp5.js";import{T as Ve}from"./TopBar-UEOhfdgU.js";import{B as _e}from"./BoostModal-C1gW14Y4.js";import"./PaymentModal-DBoEzFiD.js";const Oe=({src:t,placeholder:a,className:n,...r})=>{const[d,u]=i.useState(a||t),[m,h]=i.useState(!0);return i.useEffect(()=>{if(!a){u(t),h(!1);return}const y=new Image;y.src=t,y.onload=()=>{u(t),h(!1)}},[t,a]),e.jsx("img",{...r,src:d,className:`${n} transition-all duration-500 ${m?"blur-sm scale-105":"blur-0 scale-100"}`,alt:r.alt||""})},X=({src:t,alt:a,className:n,isVerified:r,onClick:d})=>{const[u,m]=i.useState(!1);return!t||t.includes("via.placeholder.com")||t==="undefined"||t==="null"||u?e.jsxs("div",{onClick:d,className:`${n} bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center text-gray-500 relative cursor-pointer shadow-inner`,children:[e.jsx("i",{className:"fas fa-user text-xs opacity-50"}),r&&e.jsx("div",{className:"absolute -bottom-1 -right-1 bg-blue-500 text-white text-[8px] w-4 h-4 flex items-center justify-center rounded-full border-2 border-white",children:e.jsx("i",{className:"fas fa-check"})})]}):e.jsxs("div",{className:"relative inline-block",onClick:d,children:[e.jsx("img",{src:t,alt:a||"User",className:`${n} bg-gray-100 object-cover cursor-pointer`,onError:()=>m(!0),loading:"lazy"}),r&&e.jsx("div",{className:"absolute -bottom-1 -right-1 bg-blue-500 text-white text-[8px] w-4 h-4 flex items-center justify-center rounded-full border-2 border-white",children:e.jsx("i",{className:"fas fa-check"})})]})},qe=t=>new Promise(a=>{const n=document.createElement("canvas"),r=document.createElement("video");r.autoplay=!0,r.muted=!0,r.src=URL.createObjectURL(t),r.onloadeddata=()=>{n.width=r.videoWidth,n.height=r.videoHeight,r.currentTime=1},r.onseeked=()=>{n.getContext("2d").drawImage(r,0,0,r.videoWidth,r.videoHeight),n.toBlob(u=>{URL.revokeObjectURL(r.src),a(u)},"image/jpeg",.7)}}),We=t=>{if(t.thumbnailURL)return t.thumbnailURL;if(t.mediaType==="image"&&t.mediaURL)try{return t.mediaURL.split("&token=")[0].replace(/(\.[a-zA-Z0-9]+)(\?alt=media)/,"_200x200$1$2")}catch{return null}return null},He=t=>{const[a,n]=i.useState(null);return i.useEffect(()=>{if(!(!t||typeof t!="string"))try{const r=K($(N,"users",t),d=>{d.exists()&&n(d.data())},d=>console.warn("Author fetch ignored:",d.code));return()=>r()}catch{console.warn("Invalid UID")}},[t]),a},be=()=>e.jsxs("div",{className:"glass-panel rounded-[30px] p-6 mb-8 border border-white/40 animate-pulse",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-2xl bg-gray-200/50"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-200/50 rounded w-1/3"}),e.jsx("div",{className:"h-3 bg-gray-200/50 rounded w-1/4"})]})]}),e.jsx("div",{className:"h-4 bg-gray-200/50 rounded w-full mb-2"}),e.jsx("div",{className:"h-4 bg-gray-200/50 rounded w-3/4 mb-4"}),e.jsx("div",{className:"w-full h-64 bg-gray-200/50 rounded-[24px]"})]}),Je=({viewIds:t=[],reactions:a=[],onClose:n})=>{const[r,d]=i.useState([]),[u,m]=i.useState(!0);return i.useEffect(()=>{(async()=>{if(!Array.isArray(t)||t.length===0){m(!1);return}try{const y=t.filter(o=>typeof o=="string"&&o.trim()!=="");if(y.length===0){m(!1);return}const T=y.map(o=>we($(N,"users",o))),l=(await Promise.all(T)).map(o=>{if(!o.exists())return null;const x=o.data(),j=a.find(I=>I.uid===o.id),S=x.displayName||x.username||"Aristocrat";return{uid:o.id,displayName:S,photoURL:x.photoURL,reaction:j?j.emoji:null}}).filter(Boolean);d(l)}catch(y){console.error("Error fetching viewers:",y)}finally{m(!1)}})()},[t,a]),e.jsxs("div",{className:"absolute inset-0 z-[60] bg-black/95 flex flex-col animate-fade-in-up",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 border-b border-white/10",children:[e.jsxs("h3",{className:"text-white font-bold text-lg",children:["Views (",t.length,")"]}),e.jsx("button",{onClick:n,className:"text-white/70 hover:text-white",children:e.jsx("i",{className:"fas fa-times text-xl"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 custom-scrollbar",children:u?e.jsx("p",{className:"text-white/50 text-center",children:"Loading..."}):r.length===0?e.jsx("p",{className:"text-white/50 text-center",children:"No views yet."}):e.jsx("div",{className:"space-y-4",children:r.map(h=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{src:h.photoURL,className:"w-10 h-10 rounded-full border border-white/20 object-cover",alt:h.displayName}),e.jsx("span",{className:"text-white font-medium text-sm",children:h.displayName})]}),h.reaction&&e.jsx("span",{className:"text-2xl animate-bounce-short",children:h.reaction})]},h.uid))})})]})},Ye=({moments:t,onClose:a,currentUser:n})=>{var U,M;const[r,d]=i.useState(0),[u,m]=i.useState(0),[h,y]=i.useState(""),[T,C]=i.useState(!1),[l,o]=i.useState(!1),[x,j]=i.useState(!1),[S,I]=i.useState(!1),[P,c]=i.useState(!1),[v,k]=i.useState(""),p=t[r],B=(n==null?void 0:n.uid)===p.uid;i.useEffect(()=>(document.body.style.overflow="hidden",()=>{document.body.style.overflow=""}),[]),i.useEffect(()=>{var f;p&&n&&!B&&!((f=p.views)!=null&&f.includes(n.uid))&&typeof n.uid=="string"&&_($(N,"moments",p.id),{views:se(n.uid)}).catch(L=>console.warn("Moment view fail",L))},[p,n,B]),i.useEffect(()=>{if(x||S||P)return;m(0);const f=setInterval(()=>{l||m(w=>w>=100?r<t.length-1?(d(L=>L+1),0):(clearInterval(f),a(),100):w+1)},50);return()=>clearInterval(f)},[r,t.length,a,l,x,S,P]);const H=async f=>{const w=document.createElement("div");w.textContent=f,w.className="fixed inset-0 flex items-center justify-center text-8xl animate-ping pointer-events-none z-[2000]",document.body.appendChild(w),setTimeout(()=>w.remove(),1e3);try{await _($(N,"moments",p.id),{reactions:se({uid:n.uid,emoji:f,timestamp:Date.now()})})}catch(L){console.error("Error reacting:",L)}},O=async f=>{if(f.preventDefault(),!!h.trim()){C(!0);try{const w=[n.uid,p.uid].sort().join("_"),L=$(N,"conversations",w);await te(L,{participants:[n.uid,p.uid],users:[{uid:n.uid,displayName:n.displayName,photoURL:n.photoURL},{uid:p.uid,displayName:p.userName,photoURL:p.userAvatar}],updatedAt:F(),isGroup:!1,lastMessage:`Replied to moment: ${h}`,lastSenderId:n.uid},{merge:!0}),await G(D(N,`conversations/${w}/messages`),{text:h,senderId:n.uid,type:"reply",replyToMoment:p.mediaURL,timestamp:F()}),y(""),o(!1)}catch(w){console.error(w)}finally{C(!1)}}},z=async()=>{window.confirm("Delete this moment?")&&(await ye($(N,"moments",p.id)),t.length===1?a():(d(0),I(!1)))},J=()=>{k(p.caption||""),c(!0),I(!1),o(!0)},Y=async()=>{try{await _($(N,"moments",p.id),{caption:v}),c(!1),o(!1)}catch(f){console.error("Update failed",f),alert("Failed to save.")}};return e.jsxs("div",{className:"fixed inset-0 z-[99999] bg-black flex flex-col w-screen h-[100dvh] overflow-hidden overscroll-none touch-none",children:[x&&e.jsx(Je,{viewIds:p.views||[],reactions:p.reactions||[],onClose:()=>{j(!1),o(!1)}}),e.jsx("div",{className:"absolute top-4 left-4 right-4 flex gap-1 z-30",children:t.map((f,w)=>e.jsx("div",{className:"h-1 bg-white/30 flex-1 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-white transition-all duration-100 ease-linear",style:{width:w<r?"100%":w===r?`${u}%`:"0%"}})},w))}),e.jsxs("div",{className:"absolute top-8 left-4 right-4 z-30 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{src:p.userAvatar,className:"w-10 h-10 rounded-full border-2 border-white/50",alt:"User"}),e.jsxs("div",{className:"flex flex-col text-left",children:[e.jsx("span",{className:"text-white font-bold text-sm shadow-black drop-shadow-md",children:p.userName||"Momento User"}),e.jsx("span",{className:"text-white/70 text-[10px]",children:(U=p.timestamp)!=null&&U.seconds?new Date(p.timestamp.seconds*1e3).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"Just now"})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[B&&e.jsxs("button",{onClick:f=>{f.stopPropagation(),j(!0),o(!0)},className:"flex items-center gap-2 bg-black/40 px-3 py-1.5 rounded-full backdrop-blur-md hover:bg-black/60 transition-colors",children:[e.jsx("i",{className:"fas fa-eye text-white text-xs"}),e.jsx("span",{className:"text-white text-xs font-bold",children:((M=p.views)==null?void 0:M.length)||0})]}),B&&e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:f=>{f.stopPropagation(),I(!S),o(!S)},className:"text-white text-lg w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20",children:e.jsx("i",{className:"fas fa-ellipsis-v"})}),S&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 w-32 bg-white rounded-xl shadow-xl overflow-hidden py-1 z-50 animate-fade-in",children:[e.jsxs("button",{onClick:J,className:"w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-pen text-xs"})," Edit"]}),e.jsxs("button",{onClick:z,className:"w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-trash text-xs"})," Delete"]})]})]}),e.jsx("button",{onClick:a,className:"text-white text-3xl drop-shadow-md",children:e.jsx("i",{className:"fas fa-times"})})]})]}),e.jsxs("div",{className:"flex-1 relative flex items-center justify-center bg-gray-900",children:[p.mediaType==="video"?e.jsx("video",{src:p.mediaURL,autoPlay:!l&&!x&&!S&&!P,muted:!1,playsInline:!0,className:"max-h-full max-w-full object-contain"}):e.jsx("img",{src:p.mediaURL,className:"max-h-full max-w-full object-contain",alt:"Moment",loading:"lazy",decoding:"async"}),!x&&!S&&!P&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute inset-y-0 left-0 w-1/3 z-20",onClick:f=>{f.stopPropagation(),r>0&&(d(w=>w-1),m(0))}}),e.jsx("div",{className:"absolute inset-y-0 right-0 w-1/3 z-20",onClick:f=>{f.stopPropagation(),r<t.length-1?(d(w=>w+1),m(0)):a()}})]}),e.jsx("div",{className:"absolute bottom-24 left-0 right-0 px-6 text-center z-40",children:P?e.jsxs("div",{className:"flex gap-2 animate-fade-in-up",children:[e.jsx("input",{autoFocus:!0,value:v,onChange:f=>k(f.target.value),className:"flex-1 bg-black/50 text-white border border-white/50 rounded-xl px-4 py-2 backdrop-blur-md outline-none",placeholder:"Add a caption..."}),e.jsx("button",{onClick:Y,className:"bg-white text-black px-4 rounded-xl font-bold",children:"Save"})]}):p.caption&&e.jsx("p",{className:"text-white font-medium drop-shadow-md bg-black/30 inline-block px-3 py-1 rounded-xl backdrop-blur-sm",children:p.caption})})]}),!B&&!x&&e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-4 pb-8 bg-gradient-to-t from-black/80 to-transparent z-30 flex flex-col gap-4",children:[!l&&e.jsx("div",{className:"flex gap-4 overflow-x-auto no-scrollbar pb-2 justify-center animate-fade-in",children:["ðŸ”¥","ðŸ˜‚","ðŸ˜","ðŸ˜®","ðŸ˜¢","ðŸ‘"].map(f=>e.jsx("button",{onClick:()=>H(f),className:"text-3xl hover:scale-125 transition-transform active:scale-95",children:f},f))}),e.jsxs("form",{onSubmit:O,className:"flex gap-2 items-center",children:[e.jsx("input",{value:h,onChange:f=>y(f.target.value),onFocus:()=>o(!0),onBlur:()=>!h&&o(!1),placeholder:"Reply to story...",className:"flex-1 bg-transparent border border-white/50 rounded-full px-5 py-3 text-white placeholder-white/70 outline-none focus:border-white focus:bg-black/50 transition-all text-sm backdrop-blur-sm z-40"}),e.jsx("button",{type:"submit",disabled:!h.trim()||T,className:"text-white text-xl p-2 hover:text-primary transition-colors disabled:opacity-50 z-40",children:e.jsx("i",{className:"fas fa-paper-plane"})})]})]})]})},Ze=({currentUser:t,onUpload:a})=>{const[n,r]=i.useState([]),[d,u]=i.useState(null),[m,h]=i.useState([]),y=i.useRef(null);i.useEffect(()=>{if(!t||!t.uid)return;const l=D(N,`users/${t.uid}/following`),o=K(l,x=>{const j=x.docs.map(S=>S.id);h([...j,t.uid])},x=>console.log("Following fetch skipped:",x.code));return()=>o()},[t]),i.useEffect(()=>{if(m.length===0)return;const l=new Date(Date.now()-24*60*60*1e3),o=me(D(N,"moments"),ze("timestamp",">",l),ue("timestamp","desc")),x=K(o,j=>{const P=j.docs.map(v=>({id:v.id,...v.data()})).filter(v=>m.includes(v.uid)).reduce((v,k)=>(v[k.uid]||(v[k.uid]=[]),v[k.uid].push(k),v),{}),c=Object.entries(P).map(([v,k])=>({uid:v,items:k,userAvatar:k[0].userAvatar,userName:k[0].userName,latestTimestamp:k[0].timestamp})).sort((v,k)=>k.latestTimestamp-v.latestTimestamp);r(c)},j=>{console.warn("Moments fetch failed (likely network/adblock):",j.code)});return()=>x()},[m]);const T=l=>{const o=l.target.files[0];o&&a(o)},C=l=>{if(!l)return{};const o=Date.now(),x=l.seconds*1e3,j=o-x,S=24*60*60*1e3;return{background:`conic-gradient(#008080 ${100-j/S*100}%, #e5e7eb 0)`}};return e.jsxs("div",{className:"mb-8",children:[e.jsxs("h3",{className:"font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-500 via-orange-400 to-yellow-500 mb-4 flex items-center gap-2 text-2xl tracking-tighter animate-pulse",children:[e.jsx("i",{className:"fas fa-bolt text-yellow-500 animate-bounce"})," Momento"]}),e.jsxs("div",{className:"flex gap-4 overflow-x-auto pb-4 no-scrollbar px-1",children:[e.jsxs("div",{className:"flex-shrink-0 cursor-pointer group relative",onClick:()=>y.current.click(),children:[e.jsx("div",{className:"w-[70px] h-[70px] rounded-full border-2 border-dashed border-gray-300 flex items-center justify-center bg-white group-hover:border-primary transition-all",children:e.jsx("i",{className:"fas fa-plus text-gray-400 group-hover:text-primary text-xl"})}),e.jsx("p",{className:"text-[11px] text-center font-bold text-gray-500 mt-1 group-hover:text-primary",children:"Add Yours"}),e.jsx("input",{type:"file",ref:y,className:"hidden",accept:"image/*,video/*",onChange:T})]}),n.map(l=>{const o=l.items[0],x=l.uid===(t==null?void 0:t.uid);return e.jsxs("div",{className:"flex-shrink-0 cursor-pointer group",onClick:()=>u(l.items),children:[e.jsxs("div",{className:"relative w-[74px] h-[74px] rounded-full flex items-center justify-center p-[2px]",style:C(o.timestamp),children:[e.jsx("div",{className:"w-[68px] h-[68px] bg-white rounded-full flex items-center justify-center overflow-hidden border-2 border-white relative",children:o.mediaType==="video"?e.jsx("video",{src:o.mediaURL,className:"w-full h-full object-cover",muted:!0}):e.jsx("img",{src:o.mediaURL,className:"w-full h-full object-cover group-hover:scale-110 transition-transform duration-700",alt:"Preview",loading:"lazy"})}),e.jsx(X,{src:l.userAvatar,className:"absolute bottom-0 right-0 w-6 h-6 rounded-full border-2 border-white shadow-sm",alt:"Avatar"})]}),e.jsx("p",{className:"text-[11px] text-center font-bold text-dark mt-1 truncate w-16",children:x?"You":l.userName.split(" ")[0]})]},l.uid)})]}),d&&e.jsx(Ye,{moments:d,currentUser:t,onClose:()=>u(null)})]})},Ge=({src:t,poster:a,isPlaying:n,onFullscreen:r,isMuted:d,toggleMute:u})=>{const m=i.useRef(null),[h,y]=i.useState(0),[T,C]=i.useState(0),[l,o]=i.useState(0);i.useEffect(()=>{m.current&&(m.current.muted=d)},[d]),i.useEffect(()=>{if(m.current)if(n){const c=m.current.play();c!==void 0&&c.catch(()=>{})}else m.current.pause()},[n]);const x=()=>{const c=m.current;c&&(C(c.currentTime),y(c.currentTime/c.duration*100))},j=()=>{const c=m.current;c&&o(c.duration)},S=c=>{c.stopPropagation();const v=c.target.value/100*l;m.current&&(m.current.currentTime=v),y(c.target.value)},I=c=>{m.current&&(m.current.currentTime+=c)},P=c=>{if(!c)return"0:00";const v=Math.floor(c/60),k=Math.floor(c%60);return`${v}:${k<10?"0":""}${k}`};return e.jsxs("div",{className:"relative w-full bg-black rounded-[24px] overflow-hidden group",children:[e.jsx("video",{ref:m,src:t,poster:a,className:"w-full h-auto max-h-[600px] object-contain bg-black",loop:!0,playsInline:!0,preload:"metadata",onTimeUpdate:x,onLoadedMetadata:j,onClick:r}),e.jsx("button",{onClick:c=>{c.stopPropagation(),u()},className:"absolute top-4 right-4 z-20 w-9 h-9 bg-black/40 backdrop-blur-md rounded-full flex items-center justify-center text-white hover:bg-black/60 transition-all",children:e.jsx("i",{className:`fas ${d?"fa-volume-mute":"fa-volume-up"} text-xs`})}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent flex flex-col gap-2 z-20 opacity-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-white text-[10px] font-medium w-8",children:P(T)}),e.jsx("input",{type:"range",min:"0",max:"100",value:h||0,onChange:S,onClick:c=>c.stopPropagation(),className:"flex-1 h-1 bg-white/20 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:bg-white [&::-webkit-slider-thumb]:rounded-full"}),e.jsx("span",{className:"text-white text-[10px] font-medium w-8 text-right",children:P(l)})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[e.jsxs("div",{className:"flex items-center gap-6 text-white/90",children:[e.jsxs("button",{onClick:c=>{c.stopPropagation(),I(-10)},className:"hover:text-primary transition-colors flex items-center gap-1",children:[e.jsx("i",{className:"fas fa-undo-alt text-xs"}),e.jsx("span",{className:"text-[9px] font-bold",children:"10s"})]}),e.jsxs("button",{onClick:c=>{c.stopPropagation(),I(10)},className:"hover:text-primary transition-colors flex items-center gap-1",children:[e.jsx("i",{className:"fas fa-redo-alt text-xs"}),e.jsx("span",{className:"text-[9px] font-bold",children:"10s"})]})]}),e.jsx("button",{onClick:c=>{c.stopPropagation(),r()},className:"text-white hover:scale-110 transition-transform",children:e.jsx("i",{className:"fas fa-expand text-sm"})})]})]})]})},Ke=i.memo(({post:t,user:a,isLikedByMe:n,playingPostId:r,videoContainerRefs:d,setActiveMenuPostId:u,activeMenuPostId:m,setBoostTarget:h,handleTogglePrivate:y,handleDelete:T,handleSavePost:C,setReportingPostId:l,setReportModalOpen:o,setFullscreenMedia:x,openVideoInWatch:j,handleLike:S,toggleCommentBox:I,handleShare:P,activeCommentBox:c,setActiveCommentBox:v,commentText:k,setCommentText:p,replyingToId:B,setReplyingToId:H,submitComment:O,toggleNav:z,navigate:J,isGlobalMuted:Y,toggleGlobalMute:U})=>{var q;const M=He(t==null?void 0:t.uid),f=(M==null?void 0:M.photoURL)||t.userAvatar,w=(M==null?void 0:M.displayName)||t.userName||"Aristocrat",L=(M==null?void 0:M.isVerified)||t.isVerified===!0,Q=We(t);return e.jsxs("div",{className:`glass-panel rounded-[30px] p-6 hover:shadow-xl transition-all duration-300 border relative ${L?"border-blue-100 shadow-blue-50":"border-white/60"}`,children:[t.isPromoted&&e.jsx("div",{className:"absolute top-4 right-16 text-[10px] font-bold text-gray-400 uppercase tracking-wider bg-gray-100 px-2 py-1 rounded",children:"Promoted"}),e.jsxs("div",{className:"flex justify-between items-start mb-5",children:[e.jsxs("div",{className:"flex items-center gap-4 cursor-pointer group",onClick:()=>J(`/profile/${t.uid}`),children:[e.jsx(X,{src:f,className:`w-12 h-12 rounded-2xl object-cover ${L?"ring-2 ring-offset-2 ring-blue-500":""}`,alt:"User Avatar",isVerified:L}),e.jsxs("div",{children:[e.jsxs("h4",{className:`font-bold text-lg leading-tight flex items-center gap-1 ${L?"text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-blue-400":"text-dark group-hover:text-primary"}`,children:[w,L&&e.jsx("i",{className:"fas fa-check-circle text-blue-500 text-sm ml-1",title:"Verified"}),t.isPrivate&&e.jsx("i",{className:"fas fa-lock text-xs text-gray-400 ml-1"})]}),e.jsx("p",{className:"text-xs text-gray-500 font-medium",children:(q=t.timestamp)!=null&&q.seconds?new Date(t.timestamp.seconds*1e3).toLocaleString("en-US",{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"short"}):"Just now"})]})]}),e.jsxs("div",{className:"relative post-menu-container",children:[e.jsx("button",{onClick:()=>u(m===t.id?null:t.id),className:"w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-400",children:e.jsx("i",{className:"fas fa-ellipsis-h"})}),m===t.id&&e.jsx("div",{className:"absolute right-0 top-full mt-2 w-48 bg-white/95 backdrop-blur-xl rounded-2xl shadow-xl border border-white/50 overflow-hidden z-20 py-1 animate-fade-in",children:(a==null?void 0:a.uid)===t.uid?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{h({id:t.id,type:"post",name:"Your Post"}),u(null)},className:"w-full text-left px-4 py-3 text-sm text-yellow-600 hover:bg-gray-50 font-bold flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-rocket"})," Boost Post"]}),e.jsxs("button",{onClick:()=>y(t),className:"w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3",children:[e.jsx("i",{className:`fas ${t.isPrivate?"fa-globe":"fa-lock"} text-gray-500 w-4`})," ",t.isPrivate?"Make Public":"Make Private"]}),e.jsxs("button",{onClick:()=>T(t.id),className:"w-full text-left px-4 py-2.5 text-sm text-accent hover:bg-red-50 font-bold flex items-center gap-3",children:[e.jsx("i",{className:"fas fa-trash w-4"})," Delete"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>C(t),className:"w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",children:[e.jsx("i",{className:"far fa-bookmark w-4 text-center"})," Save Post"]}),e.jsxs("button",{onClick:()=>{l(t.id),o(!0),u(null)},className:"w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-flag w-4 text-center"})," Report"]})]})})]})]}),e.jsx(Xe,{text:t.text,hasMedia:!!t.mediaURL}),t.mediaURL&&e.jsx("div",{className:"rounded-[24px] overflow-hidden mb-5 shadow-md border border-white/50 group relative","data-id":t.id,"data-mediatype":t.mediaType,ref:V=>d.current[t.id]=V,children:t.mediaType==="video"?e.jsx(Ge,{src:t.mediaURL,poster:Q,isPlaying:r===t.id,onFullscreen:()=>j(t),isMuted:Y,toggleMute:U}):e.jsx("div",{className:"w-full h-auto cursor-pointer",onClick:()=>x({url:t.mediaURL,type:t.mediaType}),children:e.jsx(Oe,{src:t.mediaURL,placeholder:Q,className:"w-full h-auto max-h-[650px] pointer-events-none"})})}),e.jsxs("div",{className:"flex items-center gap-3 pt-2 border-t border-gray-100/50",children:[e.jsxs("button",{onClick:()=>S(t),className:`h-10 px-5 rounded-xl border flex items-center gap-2 transition-all group shadow-sm ${n?"bg-accent/10 border-accent/20 text-accent":"bg-white/50 border-white text-gray-600 hover:text-accent hover:bg-white"}`,children:[e.jsx("i",{className:`${n?"fas":"far"} fa-heart group-hover:scale-110`}),e.jsx("span",{className:"font-bold text-sm",children:t.likes||0})]}),e.jsxs("button",{onClick:()=>I(t.id),className:"h-10 px-5 rounded-xl bg-white/50 border border-white flex items-center gap-2 text-gray-600 hover:text-primary hover:bg-white transition-all group shadow-sm",children:[e.jsx("i",{className:"far fa-comment group-hover:scale-110 transition-transform"}),e.jsx("span",{className:"font-bold text-sm",children:t.comments||0})]}),e.jsx("button",{onClick:()=>P(t),className:"h-10 w-10 rounded-xl bg-white/50 border border-white flex items-center justify-center text-gray-600 hover:text-dark hover:bg-white ml-auto transition-all shadow-sm",children:e.jsx("i",{className:"far fa-share-square"})})]}),c===t.id&&e.jsxs("div",{className:"mt-4 animate-fade-in",children:[e.jsx(Qe,{postId:t.id,setCommentText:p,setActiveCommentBox:v,setReplyingToId:H}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("input",{type:"text",placeholder:B?"Replying...":"Write a comment...",className:"flex-1 bg-white/80 border border-white/50 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 shadow-inner",value:k,onChange:V=>p(V.target.value),onKeyDown:V=>V.key==="Enter"&&O(t.id),onFocus:()=>z(!1),onBlur:()=>setTimeout(()=>z(!0),200),autoFocus:!0}),e.jsx("button",{onClick:()=>O(t.id),disabled:!k.trim(),className:"w-9 h-9 rounded-xl bg-primary text-white flex items-center justify-center shadow-md hover:bg-primary-dark transition-colors disabled:opacity-50",children:e.jsx("i",{className:"fas fa-paper-plane text-xs"})})]})]})]})}),Xe=({text:t,hasMedia:a})=>{const[n,r]=i.useState(!1),d=t||"",u=a?2:6,m=d.split(`
`),h=m.length>u||d.length>(a?100:300),y=n||!h?d:m.slice(0,u).join(`
`).slice(0,a?100:300)+"...",T=C=>C.split(/(#[a-zA-Z0-9_]+)/g).map((o,x)=>o.startsWith("#")?e.jsx("span",{className:"text-primary font-bold cursor-pointer hover:underline",children:o},x):o);return e.jsxs("div",{className:"text-gray-800 mb-3 text-[15px] leading-relaxed whitespace-pre-wrap transition-all",children:[T(y),h&&e.jsx("button",{onClick:C=>{C.stopPropagation(),r(!n)},className:"text-primary font-bold ml-1 hover:underline focus:outline-none text-sm",children:n?"Show Less":"Read More"})]})},Qe=({postId:t,setCommentText:a,setActiveCommentBox:n,setReplyingToId:r})=>{const d=ve(),[u,m]=i.useState([]);i.useEffect(()=>{if(!t)return;const l=me(D(N,"posts",t,"comments"),ue("timestamp","asc")),o=K(l,x=>{m(x.docs.map(j=>({id:j.id,...j.data()})))},x=>{console.log("Comments fetch error:",x.code)});return()=>o()},[t]);const h=u.filter(l=>!l.parentId),y=l=>u.filter(o=>o.parentId===l),T=l=>{a(`@${l.userName} `),n(t),r(l.parentId||l.id)},C=({c:l,isReply:o})=>{var x;return e.jsxs("div",{className:`flex gap-3 items-start text-sm mb-3 ${o?"ml-10 mt-1":""}`,children:[e.jsx(X,{src:l.userAvatar,className:"w-8 h-8 rounded-full object-cover flex-shrink-0 border border-gray-200 cursor-pointer",alt:l.userName,onClick:()=>d(`/profile/${l.uid}`)}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"bg-gray-50 px-3 py-2 rounded-2xl rounded-tl-none border border-gray-100 inline-block",children:[e.jsxs("span",{className:"font-bold text-xs block text-dark flex items-center gap-1 cursor-pointer hover:underline mb-0.5",onClick:()=>d(`/profile/${l.uid}`),children:[l.userName,l.isVerified&&e.jsx("i",{className:"fas fa-check-circle text-blue-500 text-[10px]",title:"Verified"})]}),e.jsx("p",{className:"text-gray-700 leading-snug",children:l.text})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-1 ml-1",children:[e.jsx("span",{className:"text-[10px] text-gray-400",children:(x=l.timestamp)!=null&&x.seconds?new Date(l.timestamp.seconds*1e3).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"Just now"}),!o&&e.jsx("button",{onClick:()=>T(l),className:"text-[10px] font-bold text-gray-500 hover:text-primary transition-colors",children:"Reply"})]})]})]})};return u.length===0?e.jsx("p",{className:"text-xs text-gray-400 text-center py-4",children:"No comments yet."}):e.jsx("div",{className:"mt-4 pt-2 border-t border-gray-50 max-h-[300px] overflow-y-auto custom-scrollbar px-1",children:h.map(l=>e.jsxs("div",{children:[e.jsx(C,{c:l,isReply:!1}),y(l.id).map(o=>e.jsx(C,{c:o,isReply:!0},o.id))]},l.id))})},et=({posts:t,onTagClick:a})=>{const n=i.useMemo(()=>{const r={};return t.forEach(d=>{if(!d.text)return;const u=d.text.match(/#[a-zA-Z0-9_]+/g);u&&u.forEach(m=>{r[m]=(r[m]||0)+1})}),Object.entries(r).sort((d,u)=>u[1]-d[1]).slice(0,5).map(([d,u])=>({tag:d,count:u}))},[t]);return n.length===0?null:e.jsxs("div",{className:"glass-panel rounded-[30px] p-6 sticky top-6",children:[e.jsxs("h3",{className:"font-bold text-dark mb-6 flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-chart-line text-primary"})," Trending"]}),n.map((r,d)=>e.jsxs("div",{className:"flex items-center gap-4 mb-4 last:mb-0 cursor-pointer group",onClick:()=>a(r.tag),children:[e.jsxs("span",{className:"text-3xl font-black text-gray-200 group-hover:text-primary/30",children:["0",d+1]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-dark text-sm group-hover:text-primary",children:r.tag}),e.jsxs("p",{className:"text-xs text-gray-400",children:[r.count," posts"]})]})]},r.tag))]})},ot=()=>{const t=ve(),[a,n]=i.useState(null),[r,d]=i.useState([]),[u,m]=i.useState(!0),[h,y]=i.useState(null),[T,C]=i.useState(null),[l,o]=i.useState(!0),x=i.useCallback(()=>o(s=>!s),[]),[j,S]=i.useState(""),[I,P]=i.useState(!1),[c,v]=i.useState(null),[k,p]=i.useState(null),[B,H]=i.useState(null),[O,z]=i.useState(0),J=i.useRef(null),[Y,U]=i.useState(null),[M,f]=i.useState(""),[w,L]=i.useState(null),[Q,q]=i.useState(null),[V,ae]=i.useState(null),[je,ie]=i.useState(!1),[xe,fe]=i.useState(null),[he,re]=i.useState(null),pe=i.useRef({}),ee=i.useRef(null),ge=s=>window.dispatchEvent(new CustomEvent("toggle-nav",{detail:{visible:s}}));i.useEffect(()=>{const s={root:null,rootMargin:"0px",threshold:.7},g=A=>{let E=0,b=null;if(h){const R=A.find(Z=>Z.target.dataset.id===h);R&&R.intersectionRatio<.7&&y(null)}A.forEach(R=>{R.target.dataset.mediatype==="video"&&R.isIntersecting&&R.intersectionRatio>.7&&R.intersectionRatio>E&&(E=R.intersectionRatio,b=R.target.dataset.id)}),b&&y(b)};return ee.current||(ee.current=new IntersectionObserver(g,s)),Object.entries(pe.current).forEach(([A,E])=>{E&&ee.current.observe(E)}),()=>ee.current.disconnect()},[r,h]),i.useEffect(()=>{const s=Fe(De,async b=>{if(b){const R=$(N,"users",b.uid);try{(await we(R)).exists()||(console.log("Creating missing user profile..."),await te(R,{uid:b.uid,displayName:b.displayName||b.email.split("@")[0],email:b.email,photoURL:b.photoURL,createdAt:F(),followers:[],following:[],savedPosts:[]},{merge:!0}))}catch(W){console.warn("Error checking user doc:",W)}const Z=K(R,W=>{W.exists()?n({uid:b.uid,...W.data()}):n({uid:b.uid,...b})},W=>{console.warn("User profile snapshot error:",W.code),n({uid:b.uid,...b})});return()=>Z()}else n(null)}),g=me(D(N,"posts"),ue("timestamp","desc")),A=K(g,b=>{d(b.docs.map(R=>({id:R.id,...R.data()}))),m(!1)},b=>{console.error("Posts snapshot error:",b.message),m(!1)}),E=b=>{b.target.closest(".post-menu-container")||q(null)};return document.addEventListener("click",E),()=>{s(),A(),document.removeEventListener("click",E)}},[]);const Ne=async s=>{if(!a)return alert("Sign in to share moments.");P(!0);try{if(s.size>50*1024*1024)return P(!1),alert("File too large (Max 50MB)");const g=ne(le,`moments/${a.uid}/${Date.now()}_${s.name}`),A=oe(g,s);A.on("state_changed",null,null,async()=>{var R;const E=await ce(A.snapshot.ref),b=a.displayName||((R=a.email)==null?void 0:R.split("@")[0])||"Aristocrat";await G(D(N,"moments"),{uid:a.uid,userName:b,userAvatar:a.photoURL,mediaURL:E,mediaType:s.type.startsWith("video/")?"video":"image",timestamp:F(),views:[],reactions:[],caption:""}),P(!1),alert("Moment shared!")})}catch(g){console.error(g),P(!1),alert("Error uploading moment.")}},ke=async s=>{const g=s.target.files[0];if(!g)return;if(g.size>50*1024*1024)return alert("File is too large. Max size is 50MB.");v(g);const A=g.type.startsWith("video/")?"video":"image";H(A),p(URL.createObjectURL(g))},Re=async()=>{if(!(!j.trim()&&!c||!a)){P(!0),z(0);try{let s=null,g=null;if(c){const A=ne(le,`posts/${a.uid}/${Date.now()}_${c.name}`),E=oe(A,c);if(await new Promise((b,R)=>{E.on("state_changed",Z=>z(Z.bytesTransferred/Z.totalBytes*100),R,async()=>{s=await ce(E.snapshot.ref),b()})}),B==="video")try{const b=await qe(c);if(b){const R=ne(le,`thumbnails/${a.uid}/${Date.now()}_thumb.jpg`);await oe(R,b),g=await ce(R)}}catch(b){console.error("Error generating thumbnail:",b)}}await G(D(N,"posts"),{text:j,uid:a.uid,userName:a.displayName||"Aristocrat",userAvatar:a.photoURL,isVerified:a.isVerified||!1,mediaURL:s,thumbnailURL:g,mediaType:B,category:"General",timestamp:F(),likes:0,likedBy:[],comments:0,isPrivate:!1,isPromoted:!1}),S(""),v(null),p(null),z(0)}catch(s){console.error(s),alert("Upload failed.")}finally{P(!1)}}},Se=async s=>{if(!a)return alert("Sign in.");if(!s||!s.id)return;const g=$(N,"posts",s.id),A=s.likedBy&&s.likedBy.includes(a.uid);try{if(A)await _(g,{likes:de(-1),likedBy:Ue(a.uid)});else if(await _(g,{likes:de(1),likedBy:se(a.uid)}),s.uid!==a.uid){const E=`like_${s.id}_${a.uid}`;await te($(N,"notifications",E),{recipientId:s.uid,senderId:a.uid,senderName:a.displayName||"User",senderAvatar:a.photoURL,type:"like",targetId:s.id,timestamp:F(),isRead:!1})}}catch(E){console.error(E)}},Ce=async s=>{if(!(!M.trim()||!a||!s))try{await G(D(N,"posts",s,"comments"),{text:M,uid:a.uid,userName:a.displayName||"Aristocrat",userAvatar:a.photoURL,isVerified:a.isVerified||!1,parentId:w,timestamp:F()}),await _($(N,"posts",s),{comments:de(1)}),f(""),L(null),ge(!0)}catch(g){console.error("Comment failed",g)}},Pe=async s=>{if(!a)return alert("Sign in to save.");if(!(!s||!s.id))try{await te($(N,"users",a.uid),{savedPosts:se(s.id)},{merge:!0}),alert("Post saved!"),q(null)}catch(g){console.error("Save failed:",g)}},Te=async s=>{!xe||!a||(await G(D(N,"reports"),{targetId:xe,type:"post",reporter:a.uid,reason:s,timestamp:F()}),alert("Report submitted."),ie(!1),fe(null))},Le=async s=>{await G(D(N,"boost_requests"),{...s,requesterId:a.uid,timestamp:F()}),await _($(N,"posts",s.targetId),{isPromoted:!0}),re(null),alert("Boost activated! Your post is now being promoted.")},Ee=async s=>{s!=null&&s.id&&(await _($(N,"posts",s.id),{isPrivate:!s.isPrivate}),q(null))},Ie=async s=>{s&&window.confirm("Are you sure you want to delete this post?")&&await ye($(N,"posts",s))},Me=async s=>{if(!(s!=null&&s.id))return;const g=`${window.location.origin}/post/${s.id}`;navigator.share?navigator.share({title:s.userName,text:s.text,url:g}):navigator.clipboard.writeText(g).then(()=>{alert("Link copied!")})},$e=s=>{Y===s?(U(null),L(null)):(U(s),f(""),L(null))},Ae=s=>{t("/watch",{state:{startVideoId:s.id}})},Be=T?r.filter(s=>{var g;return(g=s.text)==null?void 0:g.includes(T)}):r;return e.jsxs("div",{className:"p-4 md:p-6 w-full max-w-[1200px] mx-auto pb-24",children:[e.jsx(Ve,{}),e.jsx(Ze,{currentUser:a,onUpload:Ne}),e.jsx("div",{className:"flex justify-between items-center mb-8",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-black text-dark tracking-tight",children:"The Feed"}),e.jsx("p",{className:"text-gray-500 font-medium",children:T?e.jsxs("span",{children:["Filtered by ",e.jsx("span",{className:"text-primary font-bold",children:T})," ",e.jsx("button",{onClick:()=>C(null),className:"ml-2 text-red-500 text-xs hover:underline",children:"(Clear)"})]}):"Curated for you"})]})}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-8 items-start",children:[e.jsxs("div",{className:"flex-1 w-full min-w-0 space-y-8",children:[e.jsx("div",{className:"glass-panel rounded-[30px] p-2 z-20 relative",children:e.jsxs("div",{className:"bg-white/60 rounded-[24px] p-5 backdrop-blur-sm",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsx(X,{src:a==null?void 0:a.photoURL,className:"w-12 h-12 rounded-2xl object-cover",alt:"User Avatar"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("textarea",{placeholder:"Share your thoughts...",className:"w-full bg-transparent border-none outline-none text-lg resize-none mt-2 placeholder-gray-400",rows:"2",value:j,onChange:s=>S(s.target.value)}),k&&e.jsxs("div",{className:"relative mt-2 inline-block group",children:[B==="video"?e.jsx("video",{src:k,controls:!0,className:"h-32 rounded-xl bg-black"}):e.jsx("img",{src:k,className:"h-32 rounded-xl",alt:"Media Preview"}),e.jsx("button",{onClick:()=>{v(null),p(null),H(null)},className:"absolute top-1 right-1 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center",children:e.jsx("i",{className:"fas fa-times text-xs"})})]}),I&&c&&e.jsx("div",{className:"mt-3 w-full bg-gray-200 rounded-full h-2.5",children:e.jsx("div",{className:"bg-primary h-2.5 rounded-full transition-all duration-300",style:{width:`${O}%`}})})]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4 pt-4 border-t border-gray-200/50 relative",children:[e.jsxs("div",{className:"flex gap-1 items-center",children:[e.jsx("input",{type:"file",ref:J,className:"hidden",accept:"image/*,video/*",onChange:ke}),e.jsx("button",{onClick:()=>J.current.click(),className:"w-9 h-9 rounded-xl hover:bg-primary/10 text-primary flex items-center justify-center",children:e.jsx("i",{className:"fas fa-image"})})]}),e.jsx("button",{onClick:Re,disabled:I||!j.trim()&&!c,className:"bg-gradient-to-r from-primary to-primary-dark text-white px-6 py-2.5 rounded-xl font-bold hover:shadow-lg transition-all shadow-primary/20 disabled:opacity-50",children:I?`Uploading ${Math.round(O)}%`:"Tukumi"})]})]})}),u?e.jsxs(e.Fragment,{children:[e.jsx(be,{}),e.jsx(be,{})]}):Be.map(s=>{if(s.isPrivate&&s.uid!==(a==null?void 0:a.uid))return null;const g=a&&s.likedBy&&s.likedBy.includes(a.uid);return e.jsx(Ke,{post:s,user:a,isLikedByMe:g,playingPostId:h,videoContainerRefs:pe,setActiveMenuPostId:q,activeMenuPostId:Q,setBoostTarget:re,handleTogglePrivate:Ee,handleDelete:Ie,handleSavePost:Pe,setReportingPostId:fe,setReportModalOpen:ie,setFullscreenMedia:ae,openVideoInWatch:Ae,handleLike:Se,toggleCommentBox:$e,handleShare:Me,activeCommentBox:Y,setActiveCommentBox:U,commentText:M,setCommentText:f,replyingToId:w,setReplyingToId:L,submitComment:Ce,toggleNav:ge,navigate:t,isGlobalMuted:l,toggleGlobalMute:x},s.id)})]}),e.jsx("div",{className:"hidden lg:block w-[340px] space-y-6 sticky top-6",children:e.jsx(et,{posts:r,onTagClick:C})})]}),V&&e.jsxs("div",{className:"fixed inset-0 bg-black z-[5000] flex items-center justify-center p-0 overflow-hidden cursor-pointer",onClick:()=>ae(null),children:[e.jsx("img",{src:V.url,alt:"Fullscreen Media",className:"max-w-full max-h-full w-full h-auto object-contain",onClick:s=>s.stopPropagation()}),e.jsx("button",{onClick:()=>ae(null),className:"absolute top-6 right-6 text-white text-4xl drop-shadow-md z-[5001]",children:"Ã—"})]}),je&&e.jsx("div",{className:"fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center animate-fade-in p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3 text-red-500 text-xl",children:e.jsx("i",{className:"fas fa-flag"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:"Report Post"})]}),e.jsx("div",{className:"space-y-2 mb-6",children:["Spam or Fraud","Harassment","Violence","False Information"].map(s=>e.jsx("button",{onClick:()=>Te(s),className:"w-full text-left p-3 rounded-xl bg-gray-50 hover:bg-red-50 hover:text-red-600 text-gray-700 font-medium transition-colors",children:s},s))}),e.jsx("button",{onClick:()=>ie(!1),className:"w-full py-3 rounded-xl font-bold text-gray-500 hover:bg-gray-100 transition-colors",children:"Cancel"})]})}),he&&e.jsx(_e,{target:he,onClose:()=>re(null),onBoost:Le})]})};export{ot as default};
